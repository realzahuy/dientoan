<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AES-256 File Encryption</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-logo">üîê AES-256</div>
      
      <ul class="sidebar-menu">
        <li><button class="menu-btn active" data-section="files">üìÅ My Files</button></li>
        <li><button class="menu-btn" data-section="upload">üì§ Encrypt & Upload</button></li>
        <li><button class="menu-btn" data-section="tool">üîß Tool Encrypt/Decrypt</button></li>
        <li><button id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</button></li>
      </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Topbar -->
      <div class="topbar">
        <div class="user-info">
          Xin ch√†o, <span class="user-email" id="userEmail">...</span>
        </div>
      </div>
      
      <!-- Section 1: My Files -->
      <div id="filesSection" class="section active">
        <div class="dashboard-header">
          <h1>My Files</h1>
          <p>Qu·∫£n l√Ω file ƒë√£ m√£ h√≥a c·ªßa b·∫°n</p>
        </div>
        
        <!-- Files List Card -->
        <div class="dashboard-card">
          <h2>üìã Danh s√°ch file c·ªßa b·∫°n</h2>
          
          <div class="table-container">
            <table id="filesTable">
              <thead>
                <tr>
                  <th>T√™n file</th>
                  <th>Dung l∆∞·ª£ng</th>
                  <th>Ng√†y upload</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="filesTableBody">
                <tr>
                  <td colspan="4" style="text-align: center; color: #6b7280;">ƒêang t·∫£i...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Section 2: Encrypt & Upload -->
      <div id="uploadSection" class="section">
        <div class="dashboard-header">
          <h1>Encrypt & Upload</h1>
          <p>M√£ h√≥a v√† l∆∞u tr·ªØ file c·ªßa b·∫°n</p>
        </div>
        
        <!-- Upload Card -->
        <div class="dashboard-card">
          <h2>üì§ Upload & Encrypt File</h2>
          
          <div id="uploadMessage"></div>
          
          <form id="uploadForm">
            <div class="form-group">
              <label for="uploadFile">Ch·ªçn file</label>
              <input type="file" id="uploadFile" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="encryptionPassword">M·∫≠t kh·∫©u m√£ h√≥a</label>
              <input type="password" id="encryptionPassword" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-primary">Upload v√† m√£ h√≥a</button>
          </form>
        </div>
      </div>
      
      <!-- Section 3: Tool Encrypt/Decrypt -->
      <div id="toolSection" class="section">
        <div class="dashboard-header">
          <h1>Tool Encrypt/Decrypt</h1>
          <p>M√£ h√≥a v√† gi·∫£i m√£ file nhanh ch√≥ng</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
          <!-- Encrypt Card -->
          <div class="dashboard-card">
            <h2>üîí M√£ h√≥a File</h2>
            
            <div id="toolEncryptMessage"></div>
            
            <form id="toolEncryptForm">
              <div class="form-group">
                <label for="toolEncryptFile">Ch·ªçn file</label>
                <input type="file" id="toolEncryptFile" class="form-control" required>
              </div>
              
              <div class="form-group">
                <label for="toolEncryptPassword">M·∫≠t kh·∫©u m√£ h√≥a</label>
                <input type="password" id="toolEncryptPassword" class="form-control" required>
              </div>
              
              <button type="submit" class="btn btn-primary btn-block">M√£ h√≥a v√† t·∫£i xu·ªëng</button>
            </form>
          </div>
          
          <!-- Decrypt Card -->
          <div class="dashboard-card">
            <h2>üîì Gi·∫£i m√£ File</h2>
            
            <div id="toolDecryptMessage"></div>
            
            <form id="toolDecryptForm">
              <div class="form-group">
                <label for="toolDecryptFile">Ch·ªçn file .enc</label>
                <input type="file" id="toolDecryptFile" class="form-control" accept=".enc" required>
              </div>
              
              <div class="form-group">
                <label for="toolDecryptPassword">M·∫≠t kh·∫©u gi·∫£i m√£</label>
                <input type="password" id="toolDecryptPassword" class="form-control" required>
              </div>
              
              <button type="submit" class="btn btn-secondary btn-block">Gi·∫£i m√£ v√† t·∫£i xu·ªëng</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Download Modal -->
  <div id="downloadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Nh·∫≠p m·∫≠t kh·∫©u gi·∫£i m√£</h3>
      </div>
      
      <div id="downloadModalMessage"></div>
      
      <form id="downloadForm">
        <div class="form-group">
          <label for="downloadPassword">M·∫≠t kh·∫©u m√£ h√≥a file</label>
          <input type="password" id="downloadPassword" class="form-control" required>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeDownloadModal()">H·ªßy</button>
          <button type="submit" class="btn btn-primary">T·∫£i xu·ªëng</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Delete Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>X√°c nh·∫≠n x√≥a file</h3>
      </div>
      
      <div id="deleteModalMessage"></div>
      
      <p style="margin-bottom: 20px; color: #6b7280;">Nh·∫≠p m·∫≠t kh·∫©u t√†i kho·∫£n ƒë·ªÉ x√°c nh·∫≠n x√≥a file</p>
      
      <form id="deleteForm">
        <div class="form-group">
          <label for="accountPassword">M·∫≠t kh·∫©u t√†i kho·∫£n</label>
          <input type="password" id="accountPassword" class="form-control" required>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">H·ªßy</button>
          <button type="submit" class="btn btn-danger">X√≥a</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    let currentFileId = null;
    
    // Load user info
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            window.location.href = 'login.html';
            return;
          }
          throw new Error('Failed to load user info');
        }
        const user = await response.json();
        document.getElementById('userEmail').textContent = user.email;
      } catch (error) {
        console.error('Load user info error:', error);
      }
    }
    
    // Section Toggle
    document.querySelectorAll('.menu-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.dataset.section;
        
        // Update active menu
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Show section
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(section + 'Section').classList.add('active');
      });
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = 'index.html';
      } catch (error) {
        alert('L·ªói khi ƒëƒÉng xu·∫•t');
      }
    });
    
    // Load files
    async function loadFiles() {
      try {
        const response = await fetch('/api/files');
        
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = 'login.html';
            return;
          }
          throw new Error('Failed to load files');
        }
        
        const files = await response.json();
        const tbody = document.getElementById('filesTableBody');
        
        if (files.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6b7280;">Ch∆∞a c√≥ file n√†o</td></tr>';
          return;
        }
        
        tbody.innerHTML = files.map(file => `
          <tr>
            <td>${escapeHtml(file.original_name)}</td>
            <td>${formatBytes(file.size)}</td>
            <td>${formatDate(file.created_at)}</td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="openDownloadModal(${file.id})">T·∫£i xu·ªëng</button>
              <button class="btn btn-danger btn-sm" onclick="openDeleteModal(${file.id})">X√≥a</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Load files error:', error);
      }
    }
    
    // Upload Form
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById('uploadFile');
      const encryptionPassword = document.getElementById('encryptionPassword').value;
      const messageDiv = document.getElementById('uploadMessage');
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('encryptionPassword', encryptionPassword);
      
      try {
        messageDiv.innerHTML = '<div class="alert alert-success">ƒêang upload v√† m√£ h√≥a...</div>';
        
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
          messageDiv.innerHTML = '<div class="alert alert-success">Upload th√†nh c√¥ng!</div>';
          document.getElementById('uploadForm').reset();
          loadFiles();
          
          // T·ª± ƒë·ªông ·∫©n alert sau 3 gi√¢y
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          messageDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi server</div>';
      }
    });
    
    // Download Modal
    function openDownloadModal(fileId) {
      currentFileId = fileId;
      document.getElementById('downloadModal').classList.add('show');
      document.getElementById('downloadPassword').value = '';
      document.getElementById('downloadModalMessage').innerHTML = '';
    }
    
    function closeDownloadModal() {
      document.getElementById('downloadModal').classList.remove('show');
      currentFileId = null;
    }
    
    document.getElementById('downloadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = document.getElementById('downloadPassword').value;
      const messageDiv = document.getElementById('downloadModalMessage');
      
      try {
        messageDiv.innerHTML = '<div class="alert alert-success">ƒêang gi·∫£i m√£...</div>';
        
        const response = await fetch(`/api/download/${currentFileId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          
          // Get filename from header
          const disposition = response.headers.get('Content-Disposition');
          let filename = 'download';
          if (disposition) {
            const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(disposition);
            if (matches && matches[1]) {
              filename = decodeURIComponent(matches[1].replace(/['"]/g, ''));
            }
          }
          a.download = filename;
          
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          closeDownloadModal();
        } else {
          const data = await response.json();
          messageDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi server</div>';
      }
    });
    
    // Delete Modal
    function openDeleteModal(fileId) {
      currentFileId = fileId;
      document.getElementById('deleteModal').classList.add('show');
      document.getElementById('accountPassword').value = '';
      document.getElementById('deleteModalMessage').innerHTML = '';
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
      currentFileId = null;
    }
    
    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const accountPassword = document.getElementById('accountPassword').value;
      const messageDiv = document.getElementById('deleteModalMessage');
      
      try {
        const response = await fetch(`/api/delete/${currentFileId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountPassword })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          closeDeleteModal();
          loadFiles();
        } else {
          messageDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi server</div>';
      }
    });
    
    // Tool Encrypt Form (trong dashboard)
    document.getElementById('toolEncryptForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById('toolEncryptFile');
      const password = document.getElementById('toolEncryptPassword').value;
      const messageDiv = document.getElementById('toolEncryptMessage');
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('password', password);
      
      try {
        messageDiv.innerHTML = '<div class="alert alert-success">ƒêang m√£ h√≥a...</div>';
        
        const response = await fetch('/tool/encrypt', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileInput.files[0].name + '.enc';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          messageDiv.innerHTML = '<div class="alert alert-success">M√£ h√≥a th√†nh c√¥ng!</div>';
          document.getElementById('toolEncryptForm').reset();
        } else {
          const data = await response.json();
          messageDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi server</div>';
      }
    });
    
    // Tool Decrypt Form (trong dashboard)
    document.getElementById('toolDecryptForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById('toolDecryptFile');
      const password = document.getElementById('toolDecryptPassword').value;
      const messageDiv = document.getElementById('toolDecryptMessage');
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('password', password);
      
      try {
        messageDiv.innerHTML = '<div class="alert alert-success">ƒêang gi·∫£i m√£...</div>';
        
        const response = await fetch('/tool/decrypt', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          
          let filename = fileInput.files[0].name;
          if (filename.endsWith('.enc')) {
            filename = filename.slice(0, -4);
          }
          a.download = filename;
          
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          messageDiv.innerHTML = '<div class="alert alert-success">Gi·∫£i m√£ th√†nh c√¥ng!</div>';
          document.getElementById('toolDecryptForm').reset();
        } else {
          const data = await response.json();
          messageDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = '<div class="alert alert-error">L·ªói k·∫øt n·ªëi server</div>';
      }
    });
    
    // Utility functions
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Load user info and files on page load
    loadUserInfo();
    loadFiles();
  </script>
</body>
</html>
